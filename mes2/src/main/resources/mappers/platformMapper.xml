<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.mes2.mapper.platformMapper">
	<resultMap type="com.mes2.platform.domain.SoiDTO" id="order">
		<result property="order_code" column="order_code" />
		<result property="order_date" column="order_date" />
		<result property="sales_status" column="sales_status" />
		<collection property="sopList" resultMap="detail" />
	</resultMap>
	
	<resultMap type="com.mes2.platform.domain.SopDTO" id="detail">
		<result property="product_code" column="product_code" />
		<result property="sales_quantity" column="sales_quantity" />
		<association property="mdpDTO" resultMap="product" />
	</resultMap>
	
	<resultMap type="com.mes2.platform.domain.MdpDTO" id="product">
		<result property="name" column="name" />
		<result property="price" column="price" />
	</resultMap>
	
	
	<!-- 로그인 -->
	<select id="login" resultType="com.mes2.platform.domain.MdbDTO">
		select * from meta_data_business 
		where company_code = #{company_code} and pw = #{pw} and contract_status = 1
	</select>
	
	<!-- 품목 목록 조회 -->
	<select id="inqueryProduct" resultType="com.mes2.platform.domain.MdpDTO">
		select * from meta_data_product 
		<where>
			<if test="searchType.equals('품목코드')">
				and product_code like concat('%' , #{search}, '%')
			</if>
			<if test="searchType.equals('품목명')">
				and name like concat('%' , #{search}, '%')
			</if>
		</where>
	</select>
	
	<!-- 품목 하나 선택 -->
	<select id="selectProduct" resultType="com.mes2.platform.domain.MdpDTO">
		SELECT * from meta_data_product 
		WHERE product_code = #{product_code}
	</select>
	
	<!-- 발주 공통코드 -->
	<select id="getCommonCode" resultType="String">
		SELECT code_group FROM common_code 
		WHERE code_group_name = '발주'
	</select>
	
	<!-- 금일 주문건 중 마지막 주문번호 -->
	<select id="countTodayOrder" resultType="String">
		SELECT order_code FROM sales_order_info 
		WHERE order_code like concat('%', #{checkCode}, '%') 
		ORDER BY sales_index DESC 
		LIMIT 1
	</select>
	
	<!-- 발주 신청 -->
	<insert id="insertOrder" >
		insert into sales_order_info (order_code, company_code, order_date) 
		values (#{order_code}, #{company_code}, #{order_date})
	</insert>
	
	<!-- 발주 신청 품목 입력 -->
	<insert id="insertOrderProduct">
		insert into sales_order_product (order_code, product_code, sales_quantity) 
		values 
		<foreach collection="list" item="sopDTO" separator=", ">
		(#{sopDTO.order_code}, #{sopDTO.product_code}, #{sopDTO.sales_quantity})
		</foreach>	
	</insert>
	
	<!-- 주문(발주) 목록 조회 -->
	<select id="getOrderList" resultType="com.mes2.platform.domain.SoiDTO">
		select * from sales_order_info 
		where company_code = #{company_code}
	</select>
	
	<!-- 주문 상세 조회(주문 품목 조회) -->
	<select id="getOrderDetail" resultType="com.mes2.platform.domain.SoiDTO" resultMap="order">
		SELECT soi.order_code, soi.order_date, sales_status, sop.product_code, sop.sales_quantity, mdp.name, mdp.price
		FROM sales_order_info soi 
		JOIN sales_order_product sop
		ON soi.order_code = sop.order_code
		JOIN meta_data_product mdp
		ON sop.product_code = mdp.product_code
		WHERE soi.order_code = #{order_code}
	</select>
	
	<!-- 주문번호에 해당하는 주문번호, 품목코드만 조회(수정할 때 사용) -->
	<select id="getOrderProduct" resultType="com.mes2.platform.domain.SopDTO">
		SELECT order_code, product_code FROM sales_order_product
		WHERE order_code = #{order_code}
	</select>
	
	<!-- 취소 품목 삭제 -->
	<delete id="deleteOrderProduct">
			DELETE FROM sales_order_product
			WHERE order_code = #{order_code} AND product_code = #{product_code} AND product_status = 'requested'
	</delete>
	
	<!-- 주문 수량 변경 -->
	<update id="modifyOrder">
<!-- 	    <foreach collection="list" item="sopDTO" separator=";"> -->
	        UPDATE sales_order_product 
	        SET sales_quantity = #{sales_quantity} 
	        WHERE order_code = #{order_code} AND product_code = #{product_code} AND product_status = 'requested'
<!-- 	    </foreach> -->
	</update>

	
	<!-- 주문 수정 일자 업데이트 -->
	<update id="updateOrderDate">
		UPDATE sales_order_info 
		SET update_date = now() 
		WHERE order_code = #{order_code}
	</update>
	
	<!-- 주문 취소 -->
	<delete id="deleteOrder">
		DELETE FROM sales_order_info 
		WHERE order_code = #{order_code}
	</delete>
</mapper>